> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [my.oschina.net](https://my.oschina.net/lhztt/blog/915533)

### 什么是 CAP 定理

CAP 定理指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可兼得。在分布式系统中，分区容错性是必须需要实现的。所以只能在一致性和可用性之间进行权衡（AP 或者 CP）

### 单机 RDBMS 是 CA 系统

单机的 Oracle 或 MySQL 之类的传统 RDBMS 数据库没有分区容错，是 CA 系统，可以达到强一致性和可用性。

### CAP 在 MySQL 主从复制中的应用

MySQL 主从复制实现了分区容错性（P），主从复制分为异步复制和半同步复制。

从 MySQL 两种主从复制实现来看，在保证分区容错（P）的情况下，必须在性能（A）和数据一致性上（C）做出取舍。

### CAP 在 MySQL 组复制中的应用

组复制操作时序图： ![](https://dev.mysql.com/doc/refman/5.7/en/images/gr-replication-diagram.png) 组复制使用 paxos 协议广播执行状态，由于 paxos 协议的限制，必须多数 master 达成一致，写入操作才算成功，可以实现在多个 master 之间保持数据一致。如果在两个或多个 master 上并发更新同一条数据，在 certify 阶段进行操作校验，只有第一个更新操作能成功，其他更新操作返回失败。 此系统在一致性方面（C）做了妥协（强一致 -> 弱一致，有短暂数据不一致窗口），在性能方面（A）也做了妥协（比单机多了消息广播和 certify 阶段，性能略低），从而达到分区容错（P）。

### zookeeper 集群

zookeeper 集群在对外提供服务和写入数据时，必须半数以上主机可用并且数据写入成功，才返回成功。虽然有短暂的数据不一致窗口，但是因为有超过半数成功的限制条件，即使 leader 挂掉，选举出来的新 leader 也肯定会有所有完整的数据（有最新数据日志的节点才有可能被选为 leader），所以最终数据会在集群中的所有机器上保持一致（单调弱一致性：两次读取操作，后发起的不会读取到比前一次读取到的数据更老的数据）。因此 zookeeper 集群是 CP 系统。  
zookeeper 集群设计为 CP 系统的原因：zookeeper 作为分布式协调系统，可以在性能上做出妥协，但是必须要求数据是一致的，否则无法作为协调工具存在。

### redis 集群

redis 集群在写入数据时，master 写入成功即返回成功，数据异步复制到 slave 上。如果在 master 写入成功，但是在同步数据到 slave 时 master 挂掉，slave 被选为新的 master，此时刚才写入成功但没有同步到 slave 的数据会丢失。所以 redis 集群是 AP 系统。 redis 集群设计为 AP 系统的原因：redis 作为内存数据库，目的是为了提高数据存取的性能，缓存是其最常见的使用场景，性能高是 redis 的最大特点，所以只能在数据一致性上做出妥协。

### 分布式锁的选择

zookeeper 和 redis 都可以实现分布式锁（MySQL 和其他 RDBMS 也可以，但是性能较低），也都有现成的第三方库。选择 zookeeper 还是 redis 实现分布式锁，一般参照以下标准：

*   对安全性要求高，不允许出现锁失效的场景，比如和用户金钱道具相关的操作，选择 zookeeper 实现分布式锁。
*   对安全性要求不高，可以允许偶尔出现锁失效的场景，比如分布式系统执行定时任务做一些类似于归档数据的操作，如果多个实例并发执行会影响性能，但是不会造成其他负面影响。

### 总结

CAP 定理作为分布式系统的基础，在系统架构方面起引导作用。由于 CAP 定理的限制，需要根据不同使用场景，在性能和一致性之间做出选择（参照 zookeeper 和 redis）。